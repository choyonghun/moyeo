<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Chat</title>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <style>
    .chat-container {
      width: 400px;
      height: 300px;
      border: 1px solid #ccc;
      overflow-y: scroll;
    }
    .chat-message {
      padding: 5px;
      margin-bottom: 5px;
      background-color: #f2f2f2;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="chat-container" id="chatContainer"></div>

  <label for="recruitBoardId"></label>
  <input type="hidden" id="recruitBoardId" data-th-value="${recruitBoardId}">
  <input type="hidden" id="nickname" data-th-value="${nickname}">

  <label for="inputMessage"></label>
  <!--  메세지 입력창에서 엔터를 눌렀을 때 keyCode 값이 13(enter)인지 확인한다.  -->
  <input type="text" id="inputMessage" onkeydown="if (event.keyCode === 13) sendMessage()">
  <button type="button" onclick="sendMessage()">전송</button>

  <script type="text/javascript">
    const socket = new WebSocket("ws://localhost:8888/chat");

    socket.onopen = function(event) {
      console.log("WebSocket 연결이 열렸습니다.");
    };

    <!--  이전에 메세지들을 불러와서 출력한다.  -->
    let recruitBoardId = document.getElementById("recruitBoardId").value;
    $.ajax({
        url: '/chat/list?recruitBoardId='+recruitBoardId,
        type: 'GET',
        contentType: false,
        processData: false
      })
      .done(function(msgList) {
          if(msgList == null){
            popup.document.write("<p>이전 메세지가 없습니다.</p>");
          }else{
            for (const msg of msgList) {
              // 채팅 리스트를 받아와서 채팅창에 닉네임:메세지 형식으로 출력
              var chatContainer = document.getElementById("chatContainer");
              var messageElement = document.createElement("div");
              messageElement.className = "chat-message";
              messageElement.innerText = msg.nickname + ":" + msg.msg;
              chatContainer.appendChild(messageElement);
              chatContainer.scrollTop = chatContainer.scrollHeight;
            }
          }
       });


    socket.onmessage = function(event) {
      var message = event.data;
      var chatContainer = document.getElementById("chatContainer");
      var messageElement = document.createElement("div");
      messageElement.className = "chat-message";
      messageElement.innerText = message;
      chatContainer.appendChild(messageElement);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    };

    function sendMessage() {
      var inputMessage = document.getElementById("inputMessage").value;
      var nickname = document.getElementById("nickname").value;
      socket.send(nickname+":"+inputMessage);

<!--  메세지를 DB에 넣기 위해 팀 번호(=글 번호)와 멤버번호를 이용해서 저장한다.   -->
      let recruitBoardId = document.getElementById("recruitBoardId").value;

      let data = new FormData();
      data.append("msg", inputMessage);
      data.append("recruitBoardId", recruitBoardId);

      $.ajax({
        url: '/chat/addMsg',
        type: 'POST',
        contentType: false,
        processData: false,
        data:data
      })

      document.getElementById("inputMessage").value = "";
    }
  </script>

</body>
</html>